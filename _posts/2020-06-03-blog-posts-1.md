# Proxygen source code review (1)

## Interfaces and how to use them
[Proxygen](https://github.com/facebook/proxygen) is Facebook's C++ HTTP libraries. The basic components are `HTTPServer`, `RequestHandlerFactory`, and `RequestHandler` under the `/proxygen/httpserver` directory.

The official version has incorporated sample usage, which is under `/proxygen/httpserver/samples/` and it includes echo, and static http server samples.

I would like to take `static` server as an example. The `main()` function is in `StaticServer.cpp`. It first initializes `folly` and IP configs. Then you should define the `options` structure. `handlerFactories` is important in `options`.
```
options.handlerFactories = RequestHandlerChain()
      .addThen<StaticHandlerFactory>()
      .build();
```
The `StaticHandlerFactory` class is implemented by user in `StaticServer.cpp`, and it returns a new static handler. Every specific handler factory should inherit `RequestHandlerFactory`, which is a virtual class that defines some interfaces. 
```
class StaticHandlerFactory : public RequestHandlerFactory {
 public:
  void onServerStart(folly::EventBase* /*evb*/) noexcept override {}

  void onServerStop() noexcept override {}

  RequestHandler* onRequest(RequestHandler*, HTTPMessage*) noexcept override {
    return new StaticHandler;
  }
};

```
The role of handler in the whole system is that, it is attached with each request, and interacts with operation system, or upstream servers requested by the clients.

Then `options` and IPconfigs will be passed to the interfaces. Your simple static http server is completed!
```
HTTPServer server(std::move(options));
  server.bind(IPs);

  // Start HTTPServer mainloop in a separate thread
  std::thread t([&] () {
    server.start();
  });

  t.join();
  return 0;
```

## Introductions of each component
### HTTPServer
`HTTPServer.cpp` abstracts actions of server like start and stop. By using `bind()`, `codecFactory`, When starting a server, it first gets an event base to manage events in a thread pool. Most thread io, and event management in Proxygen are based on the `folly` library developed by Facebook. 

After getting an event base, it does following things in `startTcpServer()`:
1. Register `HandlerCallbacks` as the observer of thread pool. `HandlerCallbacks` implements interfaces like `threadStarted` and `threadStopped`. 
2. `AcceptorFactory` new a `HTTPServerAcceptor`, and pass it into `bootstrap_`.
3. `bootstrap_` sets `childHandler`, and thread pools for accepting connections and IO handling.

Then the server will start the main event loop.

### RequestHandler
`RequestHandler` is an abstract class and its interfaces are implemented by specific handlers like `staticHandler` to handle static requests. 

`ResponseHandler` acts as clients for `RequestHandler` subclasses and provides methods to send back the responses.

Methods of `RequestHandler` are registed as callback functions in `HTTPSession` module, to finish tasks in different stages. Some important methods include:
```
onRequest()
onBody()
onUpgrade()
onEOM()
onError()
```
#### RequestHandlerAdaptor
This class acts as an adaptor that converts `HTTPTransactionHandler` to `RequestHandler`. 
```
public:
  explicit RequestHandlerAdaptor(RequestHandler* requestHandler);
```
It implements two abstract classes: `HTTPTransactionHandler` and `ResponseHandler`. It can send response directly back to clients, or interacts with `Transport`.
